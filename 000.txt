index="ise-cloud-cdossi" sourcetype="cisco:esa"

* Selección del dominio según IN/OUT *
| eval domain = case(
        cs1="OUT", src_domain,
        cs1="IN", recipient_domain
    )

* Normalizar dirección *
| eval direction = if(cs1="IN","IN","OUT")

* Conteo por dominio y dirección (IN/OUT) *
| stats count BY domain direction

* Convertimos direction a columnas IN y OUT *
| eval IN = if(direction="IN", count, 0)
| eval OUT = if(direction="OUT", count, 0)

* Agrupación final para que solo quede una fila por dominio *
| stats sum(IN) as IN sum(OUT) as OUT by domain

| sort domain