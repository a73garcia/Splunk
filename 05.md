# üß© Power Automate ‚Äì Notificaci√≥n Teams ‚ÄúServiceNow Tarea Asignada‚Äù

## üìò Objetivo
Automatizar la notificaci√≥n en **Microsoft Teams** al recibir un correo de ServiceNow que informa sobre una tarea asignada a un grupo (por ejemplo: `SGT_IN_CBP_GL_ANTIMALW.MAIL`).

El mensaje en Teams debe incluir:

- üì¨ El **asunto** del correo.  
- üß© Los **Detalles T√©cnicos**.  
- üìÅ Los **Detalles Adicionales**.  
- Sin cabeceras ni enlaces, y con formato limpio, en negrita y multilinea.

---

## ‚öôÔ∏è Estructura del Flujo en Power Automate

### 1Ô∏è‚É£ Disparador
**Acci√≥n:** `Cuando llega un nuevo correo electr√≥nico (V3)`  
**Filtro de asunto:**  
```
fue asignada al grupo SGT_IN_CBP_GL_ANTIMALW.MAIL
```
**Carpeta:**  
```
IT Service Desk
```

---

### 2Ô∏è‚É£ Convertir el cuerpo a texto

**Acci√≥n:** `Html to text`  
**Par√°metro:**  
```
Contenido = Cuerpo del correo
```

---

### 3Ô∏è‚É£ Variable ‚Äì TextoPlano
**Acci√≥n:** `Inicializar variable`  
- Nombre: `TextoPlano`  
- Tipo: `Cadena`  
- Valor:  
  ```
  body('Html_to_text')
  ```

---

### 4Ô∏è‚É£ Extraer los bloques del correo

**Componer ‚Äì DetallesTecnicosRaw**
```powerfx
trim(
  split(
    split(variables('TextoPlano'),'DETALLES T√âCNICOS:')[1],
    'DETALLES ADICIONALES:'
  )[0]
)
```

**Componer ‚Äì DetallesAdicionalesRaw**
```powerfx
trim(
  split(
    split(variables('TextoPlano'),'DETALLES ADICIONALES:')[1],
    'Puede ver'
  )[0]
)
```

---

### 5Ô∏è‚É£ Extraer los valores individuales con control de errores

> Cada expresi√≥n usa `if(contains(...), ..., '')` para evitar fallos si el campo no aparece.

#### üîπ Detalles T√©cnicos

| Campo | Expresi√≥n PowerFx |
|:--|:--|
| **ElemPedido** | `if(contains(outputs('Componer_-_DetallesTecnicosRaw'),'Elemento pedido:'), trim(split(split(outputs('Componer_-_DetallesTecnicosRaw'),'Elemento pedido:')[1],' elemento:')[0]), '')` |
| **Elemento** | `if(contains(outputs('Componer_-_DetallesTecnicosRaw'),' elemento:'), trim(split(split(outputs('Componer_-_DetallesTecnicosRaw'),' elemento:')[1],' Estado:')[0]), '')` |
| **Estado** | `if(contains(outputs('Componer_-_DetallesTecnicosRaw'),' Estado:'), trim(split(split(outputs('Componer_-_DetallesTecnicosRaw'),' Estado:')[1],' Entorno:')[0]), '')` |
| **Entorno** | `if(contains(outputs('Componer_-_DetallesTecnicosRaw'),' Entorno:'), trim(split(split(outputs('Componer_-_DetallesTecnicosRaw'),' Entorno:')[1],' Grupo de asignaci√≥n:')[0]), '')` |
| **Grupo** | `if(contains(outputs('Componer_-_DetallesTecnicosRaw'),' Grupo de asignaci√≥n:'), trim(last(split(outputs('Componer_-_DetallesTecnicosRaw'),' Grupo de asignaci√≥n:'))), '')` |

#### üîπ Detalles Adicionales

| Campo | Expresi√≥n PowerFx |
|:--|:--|
| **Tarea** | `if(contains(outputs('Componer_-_DetallesAdicionalesRaw'),' Tarea de Cat√°logo:'), trim(split(split(outputs('Componer_-_DetallesAdicionalesRaw'),' Tarea de Cat√°logo:')[1],' Empresa:')[0]), '')` |
| **Empresa** | `if(contains(outputs('Componer_-_DetallesAdicionalesRaw'),' Empresa:'), trim(split(split(outputs('Componer_-_DetallesAdicionalesRaw'),' Empresa:')[1],' Solicitante:')[0]), '')` |
| **Solicitante** | `if(contains(outputs('Componer_-_DetallesAdicionalesRaw'),' Solicitante:'), trim(split(split(outputs('Componer_-_DetallesAdicionalesRaw'),' Solicitante:')[1],' Abierto:')[0]), '')` |
| **Abierto** | `if(contains(outputs('Componer_-_DetallesAdicionalesRaw'),' Abierto:'), trim(split(split(outputs('Componer_-_DetallesAdicionalesRaw'),' Abierto:')[1],' Fecha de vencimiento:')[0]), '')` |
| **Vencimiento** | `if(contains(outputs('Componer_-_DetallesAdicionalesRaw'),' Fecha de vencimiento:'), trim(last(split(outputs('Componer_-_DetallesAdicionalesRaw'),' Fecha de vencimiento:'))), '')` |

---

### 6Ô∏è‚É£ Publicar mensaje en Teams

**Acci√≥n:** `Publicar tarjeta adaptable en un chat o canal (versi√≥n preliminar)`  
**Publicar como:** Bot de Flow  
**Chat o canal:** seg√∫n tu destino (por ejemplo, `1to1 ‚Äì Antonio Garcia`)  

Pega este JSON completo:

```json
{
  "type": "AdaptiveCard",
  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
  "version": "1.5",
  "body": [
    {
      "type": "TextBlock",
      "text": "üì¨ @{triggerOutputs()?['body/subject']}",
      "wrap": true,
      "size": "Large",
      "weight": "Bolder",
      "color": "Accent"
    },
    {
      "type": "TextBlock",
      "text": "üß© Detalles T√©cnicos",
      "wrap": true,
      "weight": "Bolder",
      "spacing": "Medium",
      "separator": true
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_ElemPedido'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Elemento pedido: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_ElemPedido')}" }
      ]
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Elemento'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Elemento: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Elemento')}" }
      ]
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Estado'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Estado: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Estado')}" }
      ]
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Entorno'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Entorno: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Entorno')}" }
      ]
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Grupo'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Grupo de asignaci√≥n: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Grupo')}" }
      ]
    },
    {
      "type": "TextBlock",
      "text": "üìÅ Detalles Adicionales",
      "wrap": true,
      "weight": "Bolder",
      "spacing": "Medium",
      "separator": true
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Tarea'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Tarea de Cat√°logo: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Tarea')}" }
      ]
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Empresa'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Empresa: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Empresa')}" }
      ]
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Solicitante'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Solicitante: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Solicitante')}" }
      ]
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Abierto'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Abierto: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Abierto')}" }
      ]
    },
    {
      "type": "RichTextBlock",
      "isVisible": "@{not(equals(outputs('Componer_-_Vencimiento'), ''))}",
      "inlines": [
        { "type": "TextRun", "text": "Fecha de vencimiento: ", "weight": "Bolder" },
        { "type": "TextRun", "text": "@{outputs('Componer_-_Vencimiento')}" }
      ]
    }
  ]
}
```

---

## üß† Resultado en Teams

La notificaci√≥n se mostrar√° as√≠:

```
üì¨ SCTASK20571204 ‚Äì Email Security ‚Äì MTA

üß© Detalles T√©cnicos
Elemento pedido: RITM017787154  
Elemento: Email Security ‚Äì MTA  
Estado: Closed Complete  
Entorno: Production  
Grupo de asignaci√≥n: SGT_IN_CBP_GL_ANTIMALW.MAIL

üìÅ Detalles Adicionales
Tarea de Cat√°logo: SCTASK20571204  
Empresa: Santander Consumer Germany  
Solicitante: Nadine Gottal  
Abierto: 08/10/2025 17:07:47 CEST  
Fecha de vencimiento: 15/10/2025 17:07:48 CEST
```

---

## ‚úÖ Beneficios

- Control total de errores (`contains()` evita fallos).  
- Oculta l√≠neas vac√≠as autom√°ticamente (`isVisible`).  
- Compatible con Adaptive Card v1.5.  
- Limpio, profesional y mantenible.

---

**Autor:** Equipo Seguridad Correo  
**Versi√≥n:** 1.2  
**√öltima actualizaci√≥n:** Octubre 2025
