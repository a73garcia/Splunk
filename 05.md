trim(
    if(
        contains(body('Html_to_text'),'Catálogo:'),
        first(split(skip(split(body('Html_to_text'),'Catálogo:'),1),'\n')),
        ''
    )
)


trim(
  if(
    greaterOrEquals(
      indexOf(replace(outputs('Html_to_text')?['body'], '\r\n','\n'), 'Catálogo:'),
      0
    ),
    first(
      split(
        // trozo de texto que viene después de "Catálogo:"
        substring(
          replace(outputs('Html_to_text')?['body'], '\r\n','\n'),
          add(
            indexOf(replace(outputs('Html_to_text')?['body'], '\r\n','\n'), 'Catálogo:'),
            length('Catálogo:')
          ),
          4000
        ),
        '\n'
      )
    ),
    'N/A'   // valor por defecto si no se encuentra
  )
)

trim(
  first(
    split(
      last(
        split(variables('Cuerpo'), 'DETALLES TÉCNICOS')
      ),
      '\n\n\n \n\n'
    )
  )
)




trim(
  replace(
    replace(
      first(
        split(
          last(
            split(
              replace(variables('Cuerpo'), '\r\n','\n'),
              'DETALLES TÉCNICOS:'
            )
          ),
          '\n\n\n\n\n'           // corta antes del bloque de 5 \n (donde empieza "Puede...")
        )
      ),
      ':\n\n',''                  // elimina ":\n\n" si aparece al inicio
    ),
    '\n\n',''                     // y limpia un doble \n inicial si quedara
  )
)

substring(variables('Peticion'), 0, indexOf(variables('Peticion'), 'Puede ver'))

substring(variables('Peticion'), indexOf(variables('Peticion'), 'Detalles Técnicos'), length(variables('Peticion')))

replace(variables('Notificacion'), '\n', decodeUriComponent('%0A'))

if(
  contains(variables('Notificacion'),'Elemento pedido: '),
  trim(
    first(
      split(
        last(
          split(
            replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
            'Elemento pedido: '
          )
        ),
        concat(decodeUriComponent('%0A'),'Elemento')
      )
    )
  ),
  ''
)

---

if(
  contains(variables('Notificacion'),'pedido:'),
  trim(
    if(
      contains(
        last(
          split(
            replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
            'pedido:'
          )
        ),
        concat(decodeUriComponent('%0A'),'Elemento')
      ),
      first(
        split(
          last(
            split(
              replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
              'pedido:'
            )
          ),
          concat(decodeUriComponent('%0A'),'Elemento')
        )
      ),
      if(
        contains(
          last(
            split(
              replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
              'pedido:'
            )
          ),
          concat(decodeUriComponent('%0A'),'elemento')
        ),
        first(
          split(
            last(
              split(
                replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
                'pedido:'
              )
            ),
            concat(decodeUriComponent('%0A'),'elemento')
          )
        ),
        last(
          split(
            replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
            'pedido:'
          )
        )
      )
    )
  ),
  ''
)


trim(
  first(
    split(
      last(
        split(
          replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
          if(
            contains(variables('Notificacion'), 'Tarea de Catálogo:'),
            'Tarea de Catálogo:',
            'tarea de catálogo:'
          )
        )
      ),
      concat(decodeUriComponent('%0A'), 'Empresa')
    )
  )
)

---

trim(
  first(
    split(
      last(
        split(
          replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
          'Empresa:'
        )
      ),
      concat(decodeUriComponent('%0A'), 'Solicitante')
    )
  )
)

---

trim(
  first(
    split(
      last(
        split(
          replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
          'Solicitante:'
        )
      ),
      concat(decodeUriComponent('%0A'), 'Abierto')
    )
  )
)

---

trim(
  first(
    split(
      last(
        split(
          replace(variables('Notificacion'), decodeUriComponent('%0D%0A'), decodeUriComponent('%0A')),
          'Abierto:'
        )
      ),
      concat(decodeUriComponent('%0A'), 'Fecha')
    )
  )
)

---

<b><font color="red">Asunto:</font></b> Tarea: @{variables('stask')} (<b>@{variables('ritm')}</b>)<br>
<b>Empresa:</b> @{variables('empresa')}<br>
<b>Solicitante:</b> @{variables('solicitante')}<br>
<b>Abierto:</b> @{variables('abierto')}
