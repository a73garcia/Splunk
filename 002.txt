index=TU_INDEX sourcetype=TU_SOURCETYPE earliest=-30d
/* 1. Correo entrante únicamente (ajusta si tienes un campo de inbound/outbound) */
| where connection.protocol="smtp"  /* o direction="inbound" si lo tienes */

/* 2. Flags auxiliares usando los campos que tienes en la captura */
| eval src_ip           = connection.ip,
       sender           = envelope.from,
       final_disp       = filter.disposition,

       /* DMARC: hay varios resultados en alignment{}, buscamos cualquier 'fail' */
       dmarc_fail       = if(mvfind(filter.modules.dmarc.alignment{}.result,"fail")!=-1, 1, 0),

       /* Ejemplos de cómo marcar spam, virus, bulk, etc. AJUSTA valores */
       is_spam          = if(final_disp=="SPAM_DISP"          OR match(final_disp,"spam"), 1, 0),
       is_virus         = if(final_disp=="VIRUS_DISP"         OR match(final_disp,"virus"), 1, 0),
       is_bulk          = if(final_disp=="BULK_DISP"          OR match(final_disp,"bulk"), 1, 0),
       is_marketing     = if(final_disp=="MARKETING_DISP"     OR match(final_disp,"marketing"), 1, 0),
       is_social        = if(final_disp=="SOCIAL_DISP"        OR match(final_disp,"social"), 1, 0),
       is_clean         = if(final_disp=="DELIVERED_DISP"     OR final_disp=="delivered", 1, 0)

/* 3. Para trabajar con módulos (IP rep, domain rep, content filter, AMP, etc.) */
| mvexpand filter.actions{} 
| eval module = filter.actions{}.module,
       action = filter.actions{}.action

/* 4. Clasificación por categoría tipo “Incoming Mail Summary” */
| eval category = case(
    /* Reputación IP: AJUSTA valores de module/action a los que hayas visto */
    module=="ipr"             AND action=="reject",         "Stopped by IP Reputation Filtering",

    /* Reputación de dominio */
    module=="domain_reputation" AND action=="reject",       "Stopped by Domain Reputation Filtering",

    /* Destinatario inválido: usa lo que veas en disposition o en algún módulo */
    match(final_disp,"invalid_recipient") 
         OR match(action,"invalid_rcpt"),                   "Stopped as Invalid Recipients",

    /* SPAM */
    is_spam=1,                                              "Spam Detected",

    /* VIRUS / MALWARE */
    is_virus=1 OR module=="av" AND action=="reject",        "Virus Detected",

    /* AMP / malware avanzado */
    module=="sandbox" AND action=="reject",                 "Detected by Advanced Malware Protection",

    /* URLs maliciosas */
    module=="urlDefense" AND action=="reject",              "Messages with Malicious URLs",

    /* CONTENT FILTER */
    module=="content" AND action=="reject",                 "Stopped by Content Filter",

    /* DMARC */
    dmarc_fail=1 AND (match(final_disp,"dmarc") OR match(action,"reject")), 
                                                           "Stopped by DMARC",

    /* Graymails */
    is_marketing=1,                                         "Marketing Messages",
    is_social=1,                                            "Social Networking Messages",
    is_bulk=1,                                              "Bulk Messages",

    /* Mensajes limpios */
    is_clean=1,                                             "Clean Messages",

    /* Resto */
    true(),                                                 "Other"
)

/* 5. Como hemos mvexpand, nos quedamos con UNA categoría por mensaje 
   usando prioridad (IP rep > dominio > spam > virus > graymail > clean...) */
| eval category_priority = case(
        category=="Stopped by IP Reputation Filtering", 1,
        category=="Stopped by Domain Reputation Filtering", 2,
        category=="Stopped as Invalid Recipients", 3,
        category=="Spam Detected", 4,
        category=="Virus Detected", 5,
        category=="Detected by Advanced Malware Protection", 6,
        category=="Messages with Malicious URLs", 7,
        category=="Stopped by Content Filter", 8,
        category=="Stopped by DMARC", 9,
        category IN ("Marketing Messages","Social Networking Messages","Bulk Messages"), 10,
        category=="Clean Messages", 11,
        true(), 99)

/* Necesitas un identificador de mensaje. Usa el que tengas: messageId, queueId, etc. */
| eventstats min(category_priority) AS minprio BY filter.messageId
| where category_priority=minprio

/* 6. Conteo por categoría */
| stats count AS Messages BY category

/* 7. Totales y porcentajes */
| eventstats sum(Messages) AS Total
| eval Percent = round(Messages*100/Total, 1)

/* 8. Totales de amenazas y graymail como en el informe de Cisco */
| eval ThreatMessages = case(
        category IN ("Stopped by IP Reputation Filtering",
                     "Stopped by Domain Reputation Filtering",
                     "Stopped as Invalid Recipients",
                     "Spam Detected",
                     "Virus Detected",
                     "Detected by Advanced Malware Protection",
                     "Messages with Malicious URLs",
                     "Stopped by Content Filter",
                     "Stopped by DMARC"), Messages,
        true(), 0),
       GraymailMessages = case(
        category IN ("Marketing Messages",
                     "Social Networking Messages",
                     "Bulk Messages"), Messages,
        true(), 0)

| eventstats sum(ThreatMessages) AS TotalThreat sum(GraymailMessages) AS TotalGraymail

| appendpipe [
    stats values(TotalThreat) AS Messages values(Total) AS Total
    | eval category="Total Threat Messages"
    | eval Percent = round(Messages*100/Total,1)
]
| appendpipe [
    stats values(TotalGraymail) AS Messages values(Total) AS Total
    | eval category="Total Graymails"
    | eval Percent = round(Messages*100/Total,1)
]
| appendpipe [
    stats values(Total) AS Messages
    | eval category="Total Attempted Messages", Percent=100
]

| fields category Percent Messages
| sort -Messages