# Mapeo de campos: ServiceNow y Email HTML

Esta guía te muestra cómo **obtener y mapear** los campos hacia variables que luego se usan en el mensaje o en la Adaptive Card.

---

## A) Desde ServiceNow (conector oficial)
1. Usa la acción **Get record** o la que devuelva el item/tarea.
2. Crea **Initialize variable** (String) para cada campo:
   - `ritm` = `@{items('Apply_to_each')?['number']}` o el campo `number` correspondiente al RITM (ejemplo).
   - `elemento` = `@{body('Get_record')?['u_element']}` (ajusta al nombre real de tu tabla/campo).
   - `estado` = `@{body('Get_record')?['state']}` (o `display_value` si lo necesitas legible).
   - `entorno` = `@{body('Get_record')?['u_environment']}`.
   - `grupo` = `@{body('Get_record')?['assignment_group']?['display_value']}`.
   - `sctask` = `@{body('Get_record')?['number']}` (si el flujo parte de la SCTASK, usa su `number`).
   - `empresa` = `@{body('Get_record')?['company']?['display_value']}`.
   - `solicitante` = `@{body('Get_record')?['requested_for']?['display_value']}`.
   - `abierto` = `@{body('Get_record')?['opened_at']}`.
   - `vence` = `@{body('Get_record')?['due_date']}`.
3. Ajusta los nombres de tabla/campos a tu instancia (por ejemplo: `sc_task`, `sc_req_item`, `task`, campos prefijo `u_`, etc.).

> Tip: si recibes **IDs** en vez de descripciones, añade el parámetro `sysparm_display_value=true` en la llamada del conector (cuando exista) o haz una consulta adicional para resolver los display values.

---

## B) Desde Email HTML (por ejemplo, una notificación de ServiceNow)
1. **Html to text** sobre el cuerpo del email.
2. Encuentra los delimitadores del bloque. En el ejemplo del correo, las secciones tienen títulos “Detalles Técnicos” y “Detalles adicionales”.
3. Usa **Compose** y `split()` para aislar cada bloque:
   - Bloque Detalles Técnicos:
     ```
     outputs('Html_to_text')
       → split(…, 'Detalles Técnicos')
       → last(…)
       → split(…, 'Detalles adicionales')
       → first(…)
     ```
4. Divide el bloque por líneas (`split(…, '
')`) y para cada línea, detecta el prefijo (`"Elemento pedido:"`, `"Estado:"`, etc.) con **Condition** o expresión `startsWith()` y rellena las variables.
5. **Normaliza fechas** con `formatDateTime()` si necesitas un formato homogéneo.

### Expresiones de ejemplo
- Obtener **empresa** con tolerancia a vacíos:
  ```
  if(contains(variables('linea'), 'Empresa:'),
     trim(last(split(variables('linea'), 'Empresa:'))),
     'N/D')
  ```
- Formatear fecha:
  ```
  formatDateTime(variables('abierto'), 'yyyy-MM-dd HH:mm')
  ```

---

## Validación rápida
- Antes de enviar a Teams, añade un **Compose** final con todas las variables para verificar valores.
- Si algo viene `null` o vacío, revisa los **nombres reales** de campos en tu instancia de ServiceNow o el **HTML exacto** del correo (a veces incluye espacios no imprimibles).
