
# Gu√≠a paso a paso ‚Äî Extraer datos del **body** del correo y publicarlos en Teams

Objetivo: a partir del correo (como el de ServiceNow), extraer **solo** los campos de ‚ÄúDetalles T√©cnicos‚Äù y ‚ÄúDetalles adicionales‚Äù, guardarlos en **variables** y enviarlos a Teams.

---

## üìê Suposiciones
- El email llega con etiquetas **en espa√±ol** y con dos bloques: *Detalles T√©cnicos* y *Detalles adicionales*.
- Las etiquetas relevantes incluyen (aj√∫stalas a tu plantilla real):  
  **Elemento pedido**, **Grupo de asignaci√≥n**, **Empresa**, **Solicitante**, **Fecha de vencimiento**, **Tarea de Cat√°logo**‚Ä¶

---

## üß≠ Estructura del flujo (resumen)
1) **Trigger**: Cuando llega un nuevo correo (V3)  
2) **Html to text** (convierte body HTML a texto)  
3) **Compose ‚Äì CuerpoLimpio** (normaliza espacios y saltos)  
4) **Initialize variable** (String) √ó N campos  
5) **Set variable** √ó N (expresiones para extraer cada valor)  
6) **Compose ‚Äì MensajeTeams** (formato final)  
7) **Publicar mensaje en un chat o canal** (Teams)  

---

## 1) Trigger: *Cuando llega un nuevo correo electr√≥nico (V3)*
- Filtros recomendados: **De** = `no-reply@...` o asunto que contenga `SCTASK` (para no procesar otros correos).
- Desactiva ‚ÄúIncluir archivos adjuntos‚Äù si no los usas.

---

## 2) *Html to text*
Entrada: **Body** del trigger.  
Salida: texto plano del correo.

---

## 3) Compose ‚Äî `CuerpoLimpio`
Normaliza espacios no separables y saltos. Expresi√≥n:

```
replace(
  replace(
    replace(outputs('Html_to_text'), decodeUriComponent('%C2%A0'), ' '),
  '\r',''),
'\t','')
```

> A partir de ahora usaremos `outputs('CuerpoLimpio')` como base para los *Set variable*.

---

## 4) Inicializa las variables (tipo **String**)
Crea estas (o las que necesites):
- `sctask`
- `elementoPedido`
- `grupoAsignacion`
- `empresa`
- `vencimiento`
- `solicitante`

> Si quieres m√°s (p. ej. `estado`, `entorno`), a√±ade sus pares *Initialize* + *Set*.

---

## 5) Extrae cada valor del texto (Set variable)
Usaremos el patr√≥n: **coge todo lo que hay tras la etiqueta y antes del salto de l√≠nea**.  
Sustituye la ETIQUETA exacta (con acentos y may√∫sculas) seg√∫n el correo.

### Tarea de Cat√°logo ‚Üí `sctask`
```
trim(first(split(last(split(outputs('CuerpoLimpio'), 'Tarea de Cat√°logo:')),'\n')))
```

### Elemento pedido ‚Üí `elementoPedido`
```
trim(first(split(last(split(outputs('CuerpoLimpio'), 'Elemento pedido:')),'\n')))
```

### Grupo de asignaci√≥n ‚Üí `grupoAsignacion`
```
trim(first(split(last(split(outputs('CuerpoLimpio'), 'Grupo de asignaci√≥n:')),'\n')))
```

### Empresa ‚Üí `empresa`
```
trim(first(split(last(split(outputs('CuerpoLimpio'), 'Empresa:')),'\n')))
```

### Fecha de vencimiento ‚Üí `vencimiento`
```
trim(first(split(last(split(outputs('CuerpoLimpio'), 'Fecha de vencimiento:')),'\n')))
```

### Solicitante ‚Üí `solicitante`
```
trim(first(split(last(split(outputs('CuerpoLimpio'), 'Solicitante:')),'\n')))
```

> **Variante con valor por defecto** (si a veces falta la etiqueta):
```
if(
  contains(outputs('CuerpoLimpio'), 'Empresa:'),
  trim(first(split(last(split(outputs('CuerpoLimpio'), 'Empresa:')),'\n'))),
  'N/D'
)
```

---

## 6) Compose ‚Äî `MensajeTeams` (Markdown sencillo)
Pega este contenido y, si quieres, a√±ade/quita campos:

```md
**Detalles T√©cnicos**
‚Ä¢ Elemento pedido: @{variables('elementoPedido')}
‚Ä¢ Grupo de asignaci√≥n: @{variables('grupoAsignacion')}

**Detalles adicionales**
‚Ä¢ Tarea de Cat√°logo: @{variables('sctask')}
‚Ä¢ Empresa: @{variables('empresa')}
‚Ä¢ Solicitante: @{variables('solicitante')}
‚Ä¢ Vence: @{variables('vencimiento')}
```

---

## 7) Publicar mensaje en un chat o canal (Teams)
- **Message** = `outputs('MensajeTeams')`
- Selecciona **Equipo** y **Canal** destino.

---

## ‚úÖ Pruebas r√°pidas
- En **Historial de ejecuciones**, abre cada acci√≥n y verifica que las variables tienen valor.
- A√±ade temporalmente un **Compose ‚Äì Depuraci√≥n** con:
```
concat(
  'sctask=', variables('sctask'), '\n',
  'elemento=', variables('elementoPedido'), '\n',
  'grupo=', variables('grupoAsignacion'), '\n',
  'empresa=', variables('empresa'), '\n',
  'solicitante=', variables('solicitante'), '\n',
  'vence=', variables('vencimiento')
)
```

---

## üß© Alternativa: Adaptive Card
Si prefieres una tarjeta ordenada en Teams, usa **Post Adaptive Card** con este JSON (ajusta versi√≥n si hace falta):

```json
{
  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
  "type": "AdaptiveCard",
  "version": "1.5",
  "body": [
    { "type": "TextBlock", "text": "Detalles T√©cnicos", "weight": "Bolder", "size": "Medium", "separator": true },
    {
      "type": "FactSet",
      "facts": [
        { "title": "Elemento pedido:", "value": "@{variables('elementoPedido')}" },
        { "title": "Grupo asignaci√≥n:", "value": "@{variables('grupoAsignacion')}" }
      ]
    },
    { "type": "TextBlock", "text": "Detalles adicionales", "weight": "Bolder", "size": "Medium", "separator": true },
    {
      "type": "FactSet",
      "facts": [
        { "title": "Tarea de Cat√°logo:", "value": "@{variables('sctask')}" },
        { "title": "Empresa:", "value": "@{variables('empresa')}" },
        { "title": "Solicitante:", "value": "@{variables('solicitante')}" },
        { "title": "Vencimiento:", "value": "@{variables('vencimiento')}" }
      ]
    }
  ]
}
```

---

## üîß Consejos de robustez
- Las etiquetas **deben coincidir** con el texto del correo. Si cambian, actualiza las cadenas en `split()`.
- Algunos correos traen espacios ‚Äúraros‚Äù (`\u00A0`); por eso normalizamos con `decodeUriComponent('%C2%A0')`.
- Si el formato cambia mucho, a√±ade un `Compose` para aislar el bloque entre *Detalles T√©cnicos* y *Detalles adicionales* y luego parsea cada l√≠nea con `split(‚Ä¶,'\n')`.
- Para **fechas**, puedes homogeneizar con:  
  `formatDateTime(variables('vencimiento'),'yyyy-MM-dd HH:mm')`.

---

## üìé Relacionado en este repo
- `opcion-a-mensaje-simple.md`
- `opcion-b-adaptive-card.md`
- `mapeo-de-campos-servicenow-y-email.md`

¬°Listo! Con esto, tu notificaci√≥n en Teams mostrar√° solo lo necesario.
